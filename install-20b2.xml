<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>motokochan:recaptchaforsmf</id>
	<name>Visual Verification Options</name>

	<file name="$sourcedir/ManageRegistration.php">
		<operation>
			<search position="before"><![CDATA[
			'visual_verification_type' => isset($_POST['visual_verification_type']) ? (int) $_POST['visual_verification_type'] : 0,
]]></search>
			<add><![CDATA[
			'recaptcha_enabled' => isset($_POST['recaptchaEnable']) ? 1 : 0,
			'recaptcha_theme' => !empty($_POST['recaptchaTheme']) ? $_POST['recaptchaTheme'] : '',
			'recaptcha_public_key' => !empty($_POST['recaptchaPublicKey']) ? $_POST['recaptchaPublicKey'] : '',
			'recaptcha_private_key' => !empty($_POST['recaptchaPrivateKey']) ? $_POST['recaptchaPrivateKey'] : '',
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Register.php">
		<operation>
			<search position="before"><![CDATA[
				$_SESSION['visual_verification_code'] .= $character_range[array_rand($character_range)];
		}
	}
]]></search>
			<add><![CDATA[
	$context['use_recaptcha'] = !empty($modSettings['recaptcha_enabled']) && ($modSettings['recaptcha_enabled'] == 1 && !empty($modSettings['recaptcha_public_key']) && !empty($modSettings['recaptcha_private_key']));
	if ($context['use_recaptcha'])
	{
		// Disable the built-in visual verification if we are using reCAPTCHA
		$context['visual_verification'] = FALSE;
	}
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	if ((empty($modSettings['visual_verification_type']) || $modSettings['visual_verification_type'] != 1) && (empty($_REQUEST['visual_verification_code']) || empty($_SESSION['visual_verification_code']) || strtoupper($_REQUEST['visual_verification_code']) !== $_SESSION['visual_verification_code']))
]]></search>
			<add><![CDATA[
	if(!empty($modSettings['recaptcha_enabled']) && ($modSettings['recaptcha_enabled'] == 1 && !empty($modSettings['recaptcha_public_key']) && !empty($modSettings['recaptcha_private_key'])))
	{
		if($_POST["recaptcha_response_field"]) //Check the input if this exists, if it doesn't, then the user didn't fill it out.
		{
			require("$sourcedir/recaptchalib.php");

			$resp = recaptcha_check_answer($modSettings['recaptcha_private_key'], $_SERVER["REMOTE_ADDR"], $_POST["recaptcha_challenge_field"], $_POST["recaptcha_response_field"]);

			if (!$resp->is_valid)
				fatal_lang_error('error_wrong_verification_code', false);
		}
		else
			fatal_lang_error('error_wrong_verification_code', false);
	}
	elseif ((empty($modSettings['visual_verification_type']) || $modSettings['visual_verification_type'] != 1) && (empty($_REQUEST['visual_verification_code']) || empty($_SESSION['visual_verification_code']) || strtoupper($_REQUEST['visual_verification_code']) !== $_SESSION['visual_verification_code']))
]]></add>
		</operation>
	</file>

</modification>
